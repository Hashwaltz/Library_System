{% extends "admin/admin_base.html" %} {% block title %}Students List{%
endblock%} {% block header %}Students Management{% endblock %} {% block content
%}

<div
  class="col-span-full bg-white shadow-xl rounded-xl p-6 border-l-4 border-[#004080]"
>
  <!-- Header -->
  <div
    class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6"
  >
    <h2 class="text-xl font-semibold text-[#004080]">Students List</h2>

    <div class="flex gap-2">
      <button
        type="button"
        onclick="openAddStudentModal()"
        class="bg-[#004080] text-white px-4 py-2 rounded-lg hover:bg-[#002244] transition flex items-center gap-2"
      >
        <i class="fas fa-user-plus"></i>
        <span>Add Student</span>
      </button>
      <a
        href="#"
        class="bg-gray-400 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition flex items-center gap-2"
      >
        <i class="fas fa-user-slash"></i><span>Inactive Students</span>
      </a>
      <a
        href="#"
        class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-800 transition flex items-center gap-2"
      >
        <i class="fas fa-users-cog"></i><span>Batch Add</span>
      </a>
    </div>
  </div>

  <!-- Search -->
  <div class="mb-4">
    <input
      type="text"
      id="searchInput"
      placeholder="Search students..."
      class="w-full md:w-1/3 border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-[#004080]"
    />
  </div>

  <!-- Table -->
  <div class="overflow-x-auto">
    <table class="min-w-full border border-gray-200 rounded">
      <thead class="bg-[#004080] text-white">
        <tr>
          <th class="px-4 py-3 text-left text-sm font-semibold">
            Student Number
          </th>
          <th class="px-4 py-3 text-center text-sm font-semibold">Name</th>
          <th class="px-4 py-3 text-center text-sm font-semibold">Course</th>
          <th class="px-4 py-3 text-center text-sm font-semibold">
            Designation
          </th>
          <th class="px-4 py-3 text-center text-sm font-semibold">Email</th>
          <th class="px-4 py-3 text-center text-sm font-semibold">Status</th>
          <th class="px-4 py-3 text-center text-sm font-semibold">Actions</th>
        </tr>
      </thead>
      <tbody class="divide-y">
        {% for student in students_pagination.items %}
        <tr class="hover:bg-blue-50 cursor-pointer">
          <td class="px-4 py-3 text-center text-black">{{ student.stdnum }}</td>
          <td class="px-4 py-3 text-center text-black">
            {{ student.lastname }}, {{ student.firstname }} {{
            student.middlename or '' }}
          </td>
          <td class="px-4 py-3 text-center text-black">
            {{ student.course_rel.name }}
          </td>
          <td class="px-4 py-3 text-center text-black">
            {{ student.designation | upper }}
          </td>
          <td class="px-4 py-3 text-center text-black">{{ student.email }}</td>
          <td class="px-4 py-3 text-center">
            <span
              class="inline-block px-2 py-1 text-xs font-semibold rounded-full {% if student.status == 'ACTIVE' %} bg-green-100 text-green-700 {% elif student.status == 'INACTIVE' %} bg-red-100 text-red-700 {% else %} bg-gray-100 text-gray-700 {% endif %}"
            >
              {{ student.status }}
            </span>
          </td>

          <!-- Actions Column -->
          <td class="px-4 py-3 text-center">
            <button
              onclick='openEditStudentModal({ 
                id: {{ student.id }}, 
                stdnum: "{{ student.stdnum }}", 
                firstname: "{{ student.firstname }}", 
                middlename: "{{ student.middlename or "" }}", 
                lastname: "{{ student.lastname }}", 
                email: "{{ student.email }}", 
                designation: "{{ student.designation }}", 
                level: {{ student.level }}, 
                course_id: {{ student.course_id }}, 
                address: "{{ student.address }}", 
                contact: "{{ student.contact }}",
                status: "{{ student.status }}" 
              })'
              class="text-yellow-600 hover:text-yellow-800"
            >
              <i class="fas fa-edit"></i>
            </button>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="7" class="text-center py-6 text-gray-500">
            No students found.
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div class="mt-4 flex justify-center items-center space-x-2">
    <button
      id="prevPage"
      class="px-3 py-1 bg-[#cbd5e1] rounded hover:bg-gray-300"
    >
      Prev
    </button>
    <span id="pageInfo" class="px-3 py-1 bg-[#e2e8f0] rounded">Page 1</span>
    <button
      id="nextPage"
      class="px-3 py-1 bg-[#cbd5e1] rounded hover:bg-gray-300"
    >
      Next
    </button>
  </div>
</div>

<!-- Add Student Modal -->
<div
  id="addStudentModal"
  class="fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center z-50"
>
  <div class="bg-white rounded-lg shadow-lg w-full max-w-2xl p-6 relative">
    <button
      onclick="closeAddStudentModal()"
      class="absolute top-3 right-3 text-gray-500 hover:text-gray-700"
    >
      <i class="fas fa-times"></i>
    </button>
    <h3 class="text-xl font-semibold text-[#004080] mb-4">Add Student</h3>

    <form method="POST" action="{{ url_for('admin.add_student') }}">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Student Number -->
        <div>
          <label class="block text-sm font-medium text-gray-700"
            >Student Number</label
          >
          <input
            type="text"
            name="stdnum"
            required
            class="w-full border rounded px-3 py-2 mt-1 focus:ring-2 focus:ring-[#004080]"
          />
        </div>

        <!-- Email -->
        <div>
          <label class="block text-sm font-medium text-gray-700">Email</label>
          <input
            type="email"
            name="email"
            required
            class="w-full border rounded px-3 py-2 mt-1 focus:ring-2 focus:ring-[#004080]"
          />
        </div>

        <!-- First Name -->
        <div>
          <label class="block text-sm font-medium text-gray-700"
            >First Name</label
          >
          <input
            type="text"
            name="firstname"
            required
            class="w-full border rounded px-3 py-2 mt-1 focus:ring-2 focus:ring-[#004080]"
          />
        </div>

        <!-- Last Name -->
        <div>
          <label class="block text-sm font-medium text-gray-700"
            >Last Name</label
          >
          <input
            type="text"
            name="lastname"
            required
            class="w-full border rounded px-3 py-2 mt-1 focus:ring-2 focus:ring-[#004080]"
          />
        </div>

        <!-- Middle Name -->
        <div>
          <label class="block text-sm font-medium text-gray-700"
            >Middle Name</label
          >
          <input
            type="text"
            name="middlename"
            class="w-full border rounded px-3 py-2 mt-1 focus:ring-2 focus:ring-[#004080]"
          />
        </div>

        <!-- Level -->
        <div>
          <label class="block text-sm font-medium text-gray-700"
            >Level (1–4)</label
          >
          <input
            type="number"
            name="level"
            min="1"
            max="4"
            required
            class="w-full border rounded px-3 py-2 mt-1 focus:ring-2 focus:ring-[#004080]"
          />
        </div>

        <!-- Course (full width) -->
        <div class="md:col-span-2">
          <label class="block text-sm font-medium text-gray-700">Course</label>
          <select
            name="course_id"
            required
            class="w-full border rounded px-3 py-2 mt-1 focus:ring-2 focus:ring-[#004080]"
          >
            {% for course in courses %}
            <option value="{{ course.id }}">{{ course.name }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Designation -->
        <div>
          <label class="block text-sm font-medium text-gray-700"
            >Designation</label
          >
          <input
            type="text"
            name="designation"
            class="w-full border rounded px-3 py-2 mt-1 focus:ring-2 focus:ring-[#004080]"
          />
        </div>

        <!-- Status -->
        <div>
          <label class="block text-sm font-medium text-gray-700">Status</label>
          <select
            name="status"
            required
            class="w-full border rounded px-3 py-2 mt-1 focus:ring-2 focus:ring-[#004080]"
          >
            <option value="ACTIVE">ACTIVE</option>
            <option value="INACTIVE">INACTIVE</option>
          </select>
        </div>

        <!-- Contact -->
        <div>
          <label class="block text-sm font-medium text-gray-700"
            >Contact Number</label
          >
          <input
            type="text"
            name="contact"
            class="w-full border rounded px-3 py-2 mt-1 focus:ring-2 focus:ring-[#004080]"
          />
        </div>

        <!-- Address (full width) -->
        <div class="md:col-span-2">
          <label class="block text-sm font-medium text-gray-700">Address</label>
          <input
            type="text"
            name="address"
            class="w-full border rounded px-3 py-2 mt-1 focus:ring-2 focus:ring-[#004080]"
          />
        </div>
      </div>

      <div class="flex justify-end gap-2 mt-6">
        <button
          type="button"
          onclick="closeAddStudentModal()"
          class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400"
        >
          Cancel
        </button>
        <button
          type="submit"
          class="px-4 py-2 bg-[#004080] text-white rounded hover:bg-[#002244]"
        >
          Add Student
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Edit Student Modal -->
<div
  id="editStudentModal"
  class="fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center z-50"
>
  <div class="bg-white rounded-lg shadow-lg w-full max-w-2xl p-6 relative">
    <button
      onclick="closeEditStudentModal()"
      class="absolute top-3 right-3 text-gray-500 hover:text-gray-700"
    >
      <i class="fas fa-times"></i>
    </button>
    <h3 class="text-xl font-semibold text-[#004080] mb-4">Edit Student</h3>

    <form method="POST" id="editStudentForm">
      <!-- Hidden input for student id -->
      <input type="hidden" name="id" id="editStudentId" />

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Student Number -->
        <div>
          <label class="block text-sm font-medium text-gray-700"
            >Student Number</label
          >
          <input
            type="text"
            name="stdnum"
            id="editStdnum"
            required
            class="w-full border rounded px-3 py-2 mt-1 focus:ring-2 focus:ring-[#004080]"
          />
        </div>

        <!-- Email -->
        <div>
          <label class="block text-sm font-medium text-gray-700">Email</label>
          <input
            type="email"
            name="email"
            id="editEmail"
            required
            class="w-full border rounded px-3 py-2 mt-1 focus:ring-2 focus:ring-[#004080]"
          />
        </div>

        <!-- First Name -->
        <div>
          <label class="block text-sm font-medium text-gray-700"
            >First Name</label
          >
          <input
            type="text"
            name="firstname"
            id="editFirstname"
            required
            class="w-full border rounded px-3 py-2 mt-1 focus:ring-2 focus:ring-[#004080]"
          />
        </div>

        <!-- Last Name -->
        <div>
          <label class="block text-sm font-medium text-gray-700"
            >Last Name</label
          >
          <input
            type="text"
            name="lastname"
            id="editLastname"
            required
            class="w-full border rounded px-3 py-2 mt-1 focus:ring-2 focus:ring-[#004080]"
          />
        </div>

        <!-- Middle Name -->
        <div>
          <label class="block text-sm font-medium text-gray-700"
            >Middle Name</label
          >
          <input
            type="text"
            name="middlename"
            id="editMiddlename"
            class="w-full border rounded px-3 py-2 mt-1 focus:ring-2 focus:ring-[#004080]"
          />
        </div>

        <!-- Level -->
        <div>
          <label class="block text-sm font-medium text-gray-700"
            >Level (1–4)</label
          >
          <input
            type="number"
            name="level"
            id="editLevel"
            min="1"
            max="4"
            required
            class="w-full border rounded px-3 py-2 mt-1 focus:ring-2 focus:ring-[#004080]"
          />
        </div>

        <!-- Course (full width) -->
        <div class="md:col-span-2">
          <label class="block text-sm font-medium text-gray-700">Course</label>
          <select
            name="course_id"
            id="editCourseId"
            required
            class="w-full border rounded px-3 py-2 mt-1 focus:ring-2 focus:ring-[#004080]"
          >
            {% for course in courses %}
            <option value="{{ course.id }}">{{ course.name }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Designation -->
        <div>
          <label class="block text-sm font-medium text-gray-700"
            >Designation</label
          >
          <input
            type="text"
            name="designation"
            id="editDesignation"
            class="w-full border rounded px-3 py-2 mt-1 focus:ring-2 focus:ring-[#004080]"
          />
        </div>

        <!-- Status -->
        <div>
          <label class="block text-sm font-medium text-gray-700">Status</label>
          <select
            name="status"
            id="editStatus"
            required
            class="w-full border rounded px-3 py-2 mt-1 focus:ring-2 focus:ring-[#004080]"
          >
            <option value="ACTIVE">ACTIVE</option>
            <option value="INACTIVE">INACTIVE</option>
          </select>
        </div>

        <!-- Contact -->
        <div>
          <label class="block text-sm font-medium text-gray-700"
            >Contact Number</label
          >
          <input
            type="text"
            name="contact"
            id="editContact"
            class="w-full border rounded px-3 py-2 mt-1 focus:ring-2 focus:ring-[#004080]"
          />
        </div>

        <!-- Address (full width) -->
        <div class="md:col-span-2">
          <label class="block text-sm font-medium text-gray-700">Address</label>
          <input
            type="text"
            name="address"
            id="editAddress"
            class="w-full border rounded px-3 py-2 mt-1 focus:ring-2 focus:ring-[#004080]"
          />
        </div>
      </div>

      <div class="flex justify-end gap-2 mt-6">
        <button
          type="button"
          onclick="closeEditStudentModal()"
          class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400"
        >
          Cancel
        </button>
        <button
          type="submit"
          class="px-4 py-2 bg-[#004080] text-white rounded hover:bg-[#002244]"
        >
          Save Changes
        </button>
      </div>
    </form>
  </div>
</div>

{% endblock %} {% block scripts %}
<script>
  // Search & Pagination
  const searchInput = document.getElementById("searchInput");
  const rows = Array.from(document.querySelectorAll("tbody tr"));
  const rowsPerPage = 10;
  let currentPage = 1;

  function showPage(page) {
    const searchValue = searchInput.value.toLowerCase();
    const filteredRows = rows.filter((row) => {
      if (row.querySelector("td[colspan]")) return false;
      return Array.from(row.cells)
        .slice(1)
        .some((td) => td.textContent.toLowerCase().includes(searchValue));
    });

    const totalPages = Math.ceil(filteredRows.length / rowsPerPage) || 1;
    if (page > totalPages) currentPage = totalPages;
    if (page < 1) currentPage = 1;

    rows.forEach((r) => (r.style.display = "none"));
    filteredRows
      .slice((currentPage - 1) * rowsPerPage, currentPage * rowsPerPage)
      .forEach((r) => (r.style.display = ""));
    document.getElementById(
      "pageInfo"
    ).textContent = `Page ${currentPage} of ${totalPages}`;
  }

  document.getElementById("prevPage").addEventListener("click", () => {
    currentPage--;
    showPage(currentPage);
  });
  document.getElementById("nextPage").addEventListener("click", () => {
    currentPage++;
    showPage(currentPage);
  });
  searchInput.addEventListener("keyup", () => {
    currentPage = 1;
    showPage(currentPage);
  });
  showPage(currentPage);

  // Modal
  function openAddStudentModal() {
    document.getElementById("addStudentModal").classList.remove("hidden");
    document.getElementById("addStudentModal").classList.add("flex");
  }
  function closeAddStudentModal() {
    document.getElementById("addStudentModal").classList.add("hidden");
    document.getElementById("addStudentModal").classList.remove("flex");
  }

  // Open Edit Student Modal and populate values
  function openEditStudentModal(student) {
    document.getElementById("editStudentId").value = student.id;
    document.getElementById("editStdnum").value = student.stdnum;
    document.getElementById("editFirstname").value = student.firstname;
    document.getElementById("editMiddlename").value = student.middlename || "";
    document.getElementById("editLastname").value = student.lastname;
    document.getElementById("editEmail").value = student.email;
    document.getElementById("editDesignation").value = student.designation;
    document.getElementById("editLevel").value = student.level;
    document.getElementById("editCourseId").value = student.course_id;
    document.getElementById("editAddress").value = student.address;
    document.getElementById("editContact").value = student.contact;
    document.getElementById("editStatus").value = student.status; // Populate status
    // Set the form action dynamically
    const form = document.getElementById("editStudentForm");
    form.action = `/admin/students/edit/${student.id}`;

    const modal = document.getElementById("editStudentModal");
    modal.classList.remove("hidden");
    modal.classList.add("flex");
  }

  function closeEditStudentModal() {
    const modal = document.getElementById("editStudentModal");
    modal.classList.add("hidden");
    modal.classList.remove("flex");
  }
</script>
{% endblock %}
