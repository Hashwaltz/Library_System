{% extends "admin/admin_base.html" %} {% block title %}Manage Users{% endblock
%} {% block header %}Manage Users{% endblock %} {% block content %}
<div
  class="col-span-full bg-white shadow-xl rounded-xl p-6 border-l-4 border-[#004080]"
>
  <!-- Header + Actions -->
  <div
    class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6"
  >
    <h2 class="text-xl font-semibold text-[#004080]">User Management</h2>

    <button
      type="button"
      onclick="openAddUserModal()"
      class="bg-[#004080] text-white px-4 py-2 rounded-lg hover:bg-[#002244] transition flex items-center gap-2"
    >
      <i class="fas fa-user-plus"></i>
      <span>Add User</span>
    </button>
  </div>

  <!-- Search -->
  <div class="mb-4">
    <input
      type="text"
      id="searchInput"
      placeholder="Search users..."
      class="w-full md:w-1/3 border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-[#004080]"
    />
  </div>

  <!-- Users Table -->
  <div class="overflow-x-auto">
    <table class="min-w-full border border-gray-200 rounded">
      <thead class="bg-[#004080] text-white">
        <tr>
          <th class="px-4 py-3 text-left text-sm font-semibold">Name</th>
          <th class="px-4 py-3 text-left text-sm font-semibold">Email</th>
          <th class="px-4 py-3 text-left text-sm font-semibold">Role</th>
          <th class="px-4 py-3 text-left text-sm font-semibold">Status</th>
          <th class="px-4 py-3 text-center text-sm font-semibold">Actions</th>
        </tr>
      </thead>
      <tbody class="divide-y">
        {% for user in users %}
        <tr class="hover:bg-gray-50">
          <td class="px-4 py-3 font-medium">
            {{ user.username.capitalize() }}
          </td>
          <td class="px-4 py-3">{{ user.email }}</td>
          <td class="px-4 py-3">
            <span
              class="px-3 py-1 rounded-full text-xs font-medium {% if user.role == 'Admin' %}bg-blue-100 text-blue-800 {% elif user.role == 'Librarian' %}bg-green-100 text-green-800 {% else %}bg-yellow-100 text-yellow-800{% endif %}"
            >
              {{ user.role }}
            </span>
          </td>
          <td class="px-4 py-3">
            {% if user.is_active %}
            <span
              class="px-3 py-1 rounded-full text-xs bg-green-100 text-green-700 font-medium"
            >
              Active
            </span>
            {% else %}
            <span
              class="px-3 py-1 rounded-full text-xs bg-red-100 text-red-700 font-medium"
            >
              Inactive
            </span>
            {% endif %}
          </td>
          <td class="px-4 py-3 text-center space-x-2">
            <button
              onclick='openEditUserModal({ 
                id: {{ user.id }}, 
                username: "{{ user.username }}", 
                email: "{{ user.email }}", 
                role: "{{ user.role }}", 
                is_active: {{ "true" if user.is_active else "false" }}
              })'
              class="text-yellow-600 hover:text-yellow-800"
            >
              <i class="fas fa-edit"></i>
            </button>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="6" class="text-center py-6 text-gray-500">
            No users found.
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div class="mt-4 flex justify-center items-center space-x-2">
    <button
      id="prevPage"
      class="px-3 py-1 bg-[#cbd5e1] rounded hover:bg-gray-300"
    >
      Prev
    </button>
    <span id="pageInfo" class="px-3 py-1 bg-[#e2e8f0] rounded">Page 1</span>
    <button
      id="nextPage"
      class="px-3 py-1 bg-[#cbd5e1] rounded hover:bg-gray-300"
    >
      Next
    </button>
  </div>

  <!-- Add User Modal -->
  <div
    id="addUserModal"
    class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50"
  >
    <div
      class="bg-white w-full max-w-lg rounded-xl shadow-lg p-6 animate-fadeIn border-l-4 border-[#004080]"
    >
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-semibold text-[#004080]">Add New User</h3>
        <button
          onclick="closeAddUserModal()"
          class="text-gray-400 hover:text-gray-600"
        >
          <i class="fas fa-times text-lg"></i>
        </button>
      </div>

      <form
        method="POST"
        action="{{ url_for('admin.add_librarian') }}"
        class="space-y-4"
      >
        <div>
          <label class="block text-sm font-medium mb-1">Full Name</label>
          <input
            type="text"
            name="username"
            required
            class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-[#004080]"
          />
        </div>

        <div>
          <label class="block text-sm font-medium mb-1">Email</label>
          <input
            type="email"
            name="email"
            required
            class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-[#004080]"
          />
        </div>

        <div>
          <label class="block text-sm font-medium mb-1">Role</label>
          <select
            name="role"
            required
            class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-[#004080]"
          >
            <option value="">Select role</option>
            <option value="Admin">Admin</option>
            <option value="Librarian">Librarian</option>
            <option value="Staff">Staff</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium mb-1"
            >Temporary Password</label
          >
          <input
            type="password"
            name="password"
            required
            class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-[#004080]"
          />
          <p class="text-xs text-gray-500 mt-1">
            User can change this after first login.
          </p>
        </div>

        <div class="flex items-center gap-2">
          <input
            type="checkbox"
            name="is_active"
            checked
            class="accent-[#004080]"
          />
          <label class="text-sm">Active</label>
        </div>

        <div class="flex justify-end gap-3 pt-4">
          <button
            type="button"
            onclick="closeAddUserModal()"
            class="px-4 py-2 rounded-lg border hover:bg-gray-100"
          >
            Cancel
          </button>
          <button
            type="submit"
            class="px-4 py-2 rounded-lg bg-[#004080] text-white hover:bg-[#002244]"
          >
            Create User
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit User Modal -->
  <div
    id="editUserModal"
    class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50"
  >
    <div
      class="bg-white w-full max-w-lg rounded-xl shadow-lg p-6 animate-fadeIn border-l-4 border-[#004080]"
    >
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-semibold text-[#004080]">Edit User</h3>
        <button
          onclick="closeEditUserModal()"
          class="text-gray-400 hover:text-gray-600"
        >
          <i class="fas fa-times text-lg"></i>
        </button>
      </div>

      <form id="editUserForm" method="POST" class="space-y-4">
        <input type="hidden" name="user_id" id="editUserId" />

        <div>
          <label class="block text-sm font-medium mb-1">Full Name</label>
          <input
            type="text"
            name="username"
            id="editUsername"
            required
            class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-[#004080]"
          />
        </div>

        <div>
          <label class="block text-sm font-medium mb-1">Email</label>
          <input
            type="email"
            name="email"
            id="editEmail"
            required
            class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-[#004080]"
          />
        </div>

        <div>
          <label class="block text-sm font-medium mb-1">Role</label>
          <select
            name="role"
            id="editRole"
            required
            class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-[#004080]"
          >
            <option value="">Select role</option>
            <option value="Admin">Admin</option>
            <option value="Librarian">Librarian</option>
            <option value="Staff">Staff</option>
          </select>
        </div>

        <div class="flex items-center gap-2">
          <input
            type="checkbox"
            name="is_active"
            id="editIsActive"
            class="accent-[#004080]"
          />
          <label class="text-sm">Active</label>
        </div>

        <div class="flex justify-end gap-3 pt-4">
          <button
            type="button"
            onclick="closeEditUserModal()"
            class="px-4 py-2 rounded-lg border hover:bg-gray-100"
          >
            Cancel
          </button>
          <button
            type="submit"
            class="px-4 py-2 rounded-lg bg-[#004080] text-white hover:bg-[#002244]"
          >
            Save Changes
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  function openAddUserModal() {
    document.getElementById("addUserModal").classList.remove("hidden");
  }

  function closeAddUserModal() {
    document.getElementById("addUserModal").classList.add("hidden");
  }

  const searchInput = document.getElementById("searchInput");
  const rows = Array.from(document.querySelectorAll("tbody tr"));
  const rowsPerPage = 10;
  let currentPage = 1;

  function showPage(page) {
    const searchValue = searchInput.value.toLowerCase();
    const filteredRows = rows.filter((row) => {
      if (row.querySelector("td[colspan]")) return false;
      const username = row.cells[1].textContent.toLowerCase();
      const email = row.cells[2].textContent.toLowerCase();
      const role = row.cells[3].textContent.toLowerCase();
      return (
        username.includes(searchValue) ||
        email.includes(searchValue) ||
        role.includes(searchValue)
      );
    });

    const totalPages = Math.ceil(filteredRows.length / rowsPerPage) || 1;
    if (page > totalPages) currentPage = totalPages;
    if (page < 1) currentPage = 1;

    rows.forEach((row) => (row.style.display = "none"));
    const start = (currentPage - 1) * rowsPerPage;
    const end = start + rowsPerPage;
    filteredRows.slice(start, end).forEach((row) => (row.style.display = ""));
    document.getElementById(
      "pageInfo"
    ).textContent = `Page ${currentPage} of ${totalPages}`;
  }

  document.getElementById("prevPage").addEventListener("click", () => {
    currentPage--;
    showPage(currentPage);
  });
  document.getElementById("nextPage").addEventListener("click", () => {
    currentPage++;
    showPage(currentPage);
  });
  searchInput.addEventListener("keyup", () => {
    currentPage = 1;
    showPage(currentPage);
  });

  showPage(currentPage);

  function openEditUserModal(user) {
    document.getElementById("editUserModal").classList.remove("hidden");
    document.getElementById(
      "editUserForm"
    ).action = `/admin/edit_librarian/${user.id}`;

    document.getElementById("editUserId").value = user.id;
    document.getElementById("editUsername").value = user.username || "";
    document.getElementById("editEmail").value = user.email || "";
    document.getElementById("editRole").value = user.role || "";
    document.getElementById("editIsActive").checked = user.is_active;
  }

  function closeEditUserModal() {
    document.getElementById("editUserModal").classList.add("hidden");
  }
</script>
{% endblock %}
