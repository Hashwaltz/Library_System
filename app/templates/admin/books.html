{% extends "admin/admin_base.html" %} {% block title %}Book Management{%
endblock %} {% block header %}Book Management{% endblock %} {% block content %}
<div
  class="col-span-full bg-white shadow-xl rounded-xl p-6 border-l-4 border-[#004080]"
>
  <!-- Header + Actions -->
  <div
    class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6"
  >
    <h2 class="text-xl font-semibold text-[#004080]">Book Management</h2>

    <div class="flex gap-2">
      <!-- Add Book Button -->
      <button
        type="button"
        onclick="openAddBookModal()"
        class="bg-[#004080] text-white px-4 py-2 rounded-lg hover:bg-[#002244] transition flex items-center gap-2"
      >
        <i class="fas fa-book-medical"></i>
        <span>Add Book</span>
      </button>

      <!-- Archive Button -->
      <a
        href="{{ url_for('admin.archived_books') }}"
        class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-800 transition flex items-center gap-2"
      >
        <i class="fas fa-archive"></i>
        <span>Archive</span>
      </a>
    </div>
  </div>

  <!-- Search -->
  <div class="mb-4">
    <input
      type="text"
      id="searchInput"
      placeholder="Search books..."
      class="w-full md:w-1/3 border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-[#004080]"
    />
  </div>

  <!-- Books Table -->
  <div class="overflow-x-auto">
    <table class="min-w-full border border-gray-200 rounded">
      <thead class="bg-[#004080] text-white">
        <tr>
          <th class="px-4 py-3 text-left text-sm font-semibold">Title</th>
          <th class="px-4 py-3 text-left text-sm font-semibold">Author</th>
          <th class="px-4 py-3 text-left text-sm font-semibold">Accession #</th>
          <th class="px-4 py-3 text-left text-sm font-semibold">Call #</th>
          <th class="px-4 py-3 text-left text-sm font-semibold">Section</th>
          <th class="px-4 py-3 text-left text-sm font-semibold">Subject</th>
          <th class="px-4 py-3 text-left text-sm font-semibold">Edition</th>
          <th class="px-4 py-3 text-left text-sm font-semibold">Publisher</th>
          <th class="px-4 py-3 text-left text-sm font-semibold">Year</th>
          <th class="px-4 py-3 text-center text-sm font-semibold">Actions</th>
        </tr>
      </thead>

      <tbody class="divide-y">
        {% for book in books %}
        <tr class="hover:bg-gray-50">
          <td class="px-4 py-3 font-medium">{{ book.title }}</td>
          <td class="px-4 py-3">{{ book.author }}</td>
          <td class="px-4 py-3">{{ book.assecion_number }}</td>
          <td class="px-4 py-3">{{ book.call_number }}</td>
          <td class="px-4 py-3">
            {{ book.section.name if book.section else '-' }}
          </td>
          <td class="px-4 py-3">
            {{ book.subject_type.name if book.subject_type else '-' }}
          </td>
          <td class="px-4 py-3">
            {{ book.edition.name if book.edition else '-' }}
          </td>
          <td class="px-4 py-3">{{ book.publisher or '-' }}</td>
          <td class="px-4 py-3">{{ book.year_published or '-' }}</td>
          <td class="px-4 py-3 text-center space-x-2">
            <button
              type="button"
              onclick='openEditBookModal({{ 
                {
                  "id": book.id,
                  "title": book.title,
                  "author": book.author,
                  "assecion_number": book.assecion_number,
                  "call_number": book.call_number,
                  "publisher": book.publisher,
                  "year_published": book.year_published,
                  "section_id": book.section_id,
                  "subject_type_id": book.subject_type_id,
                  "edition_id": book.edition_id
                } | tojson 
              }})'
              class="text-yellow-600 hover:text-yellow-800"
            >
              <i class="fas fa-edit"></i>
            </button>

            <form
              method="POST"
              action="{{ url_for('admin.delete_book', book_id=book.id) }}"
              class="inline"
            >
              <button type="submit" class="text-red-600 hover:text-red-800">
                <i class="fas fa-trash"></i>
              </button>
            </form>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="11" class="text-center py-6 text-gray-500">
            No books found.
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div class="mt-4 flex justify-center items-center space-x-2">
    {% if pagination.has_prev %}
    <a
      href="{{ url_for('admin.list_books', page=pagination.prev_num) }}"
      class="px-3 py-1 bg-[#cbd5e1] rounded hover:bg-gray-300"
      >Prev</a
    >
    {% else %}
    <span class="px-3 py-1 bg-gray-200 rounded text-gray-500">Prev</span>
    {% endif %}

    <span class="px-3 py-1 bg-[#e2e8f0] rounded"
      >Page {{ pagination.page }} of {{ pagination.pages }}</span
    >

    {% if pagination.has_next %}
    <a
      href="{{ url_for('admin.list_books', page=pagination.next_num) }}"
      class="px-3 py-1 bg-[#cbd5e1] rounded hover:bg-gray-300"
      >Next</a
    >
    {% else %}
    <span class="px-3 py-1 bg-gray-200 rounded text-gray-500">Next</span>
    {% endif %}
  </div>

  <!-- Add Book Modal -->
  <div
    id="addBookModal"
    class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50"
  >
    <div
      class="bg-white w-full max-w-lg rounded-xl shadow-lg p-6 animate-fadeIn"
    >
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-semibold text-[#004080]">Add New Book</h3>
        <button
          onclick="closeAddBookModal()"
          class="text-gray-400 hover:text-gray-600"
        >
          <i class="fas fa-times text-lg"></i>
        </button>
      </div>

      <form
        method="POST"
        action="{{ url_for('admin.add_book') }}"
        class="space-y-4"
      >
        <input
          type="text"
          name="title"
          placeholder="Title"
          required
          class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-[#004080]"
        />
        <input
          type="text"
          name="author"
          placeholder="Author"
          required
          class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-[#004080]"
        />
        <input
          type="number"
          name="assecion_number"
          placeholder="Accession Number"
          required
          class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-[#004080]"
        />
        <input
          type="text"
          name="call_number"
          placeholder="Call Number"
          required
          class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-[#004080]"
        />

        <select
          name="section_id"
          class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-[#004080]"
        >
          <option value="">--Select Section--</option>
          {% for s in sections %}
          <option value="{{ s.id }}">{{ s.name }}</option>
          {% endfor %}
        </select>

        <select
          name="subject_type_id"
          class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-[#004080]"
        >
          <option value="">--Select Subject--</option>
          {% for st in subject_types %}
          <option value="{{ st.id }}">{{ st.name }}</option>
          {% endfor %}
        </select>

        <select
          name="edition_id"
          class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-[#004080]"
        >
          <option value="">--Select Edition--</option>
          {% for e in editions %}
          <option value="{{ e.id }}">{{ e.name }}</option>
          {% endfor %}
        </select>

        <input
          type="text"
          name="publisher"
          placeholder="Publisher"
          class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-[#004080]"
        />
        <input
          type="number"
          name="year_published"
          placeholder="Year Published"
          class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-[#004080]"
        />

        <div class="flex justify-end gap-3 pt-4">
          <button
            type="button"
            onclick="closeAddBookModal()"
            class="px-4 py-2 rounded-lg border hover:bg-gray-100"
          >
            Cancel
          </button>
          <button
            type="submit"
            class="px-4 py-2 rounded-lg bg-[#004080] text-white hover:bg-[#002244]"
          >
            Add Book
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Book Modal -->
  <div
    id="editBookModal"
    class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50"
  >
    <div class="bg-white w-full max-w-lg rounded-xl shadow-lg p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-semibold text-[#004080]">Edit Book</h3>
        <button
          onclick="closeEditBookModal()"
          class="text-gray-400 hover:text-gray-600"
        >
          <i class="fas fa-times text-lg"></i>
        </button>
      </div>

      <form id="editBookForm" method="POST" class="space-y-4">
        <input type="hidden" id="editBookId" />
        <input
          name="title"
          id="editTitle"
          placeholder="Title"
          class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-[#004080]"
          required
        />
        <input
          name="author"
          id="editAuthor"
          placeholder="Author"
          class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-[#004080]"
          required
        />
        <input
          name="assecion_number"
          id="editAccession"
          type="number"
          placeholder="Accession Number"
          class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-[#004080]"
          required
        />
        <input
          name="call_number"
          id="editCall"
          placeholder="Call Number"
          class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-[#004080]"
          required
        />

        <select
          name="section_id"
          id="editSection"
          class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-[#004080]"
        >
          <option value="">-- Select Section --</option>
          {% for s in sections %}
          <option value="{{ s.id }}">{{ s.name }}</option>
          {% endfor %}
        </select>

        <select
          name="subject_type_id"
          id="editSubject"
          class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-[#004080]"
        >
          <option value="">-- Select Subject --</option>
          {% for st in subject_types %}
          <option value="{{ st.id }}">{{ st.name }}</option>
          {% endfor %}
        </select>

        <select
          name="edition_id"
          id="editEdition"
          class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-[#004080]"
        >
          <option value="">-- Select Edition --</option>
          {% for e in editions %}
          <option value="{{ e.id }}">{{ e.name }}</option>
          {% endfor %}
        </select>

        <input
          name="publisher"
          id="editPublisher"
          placeholder="Publisher"
          class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-[#004080]"
        />
        <input
          name="year_published"
          id="editYear"
          type="number"
          placeholder="Year Published"
          class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-[#004080]"
        />

        <div class="flex justify-end gap-3 pt-4">
          <button
            type="button"
            onclick="closeEditBookModal()"
            class="border px-4 py-2 rounded"
          >
            Cancel
          </button>
          <button
            type="submit"
            class="bg-[#004080] text-white px-4 py-2 rounded"
          >
            Save
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  function openAddBookModal() {
    document.getElementById("addBookModal").classList.remove("hidden");
  }
  function closeAddBookModal() {
    document.getElementById("addBookModal").classList.add("hidden");
  }

  const searchInput = document.getElementById("searchInput");
  const rows = Array.from(document.querySelectorAll("tbody tr"));
  const rowsPerPage = 10;
  let currentPage = 1;

  function showPage(page) {
    const searchValue = searchInput.value.toLowerCase();
    const filteredRows = rows.filter((row) => {
      if (row.querySelector("td[colspan]")) return false;
      const title = row.cells[1].textContent.toLowerCase();
      const author = row.cells[2].textContent.toLowerCase();
      const accession = row.cells[3].textContent.toLowerCase();
      return (
        title.includes(searchValue) ||
        author.includes(searchValue) ||
        accession.includes(searchValue)
      );
    });

    const totalPages = Math.ceil(filteredRows.length / rowsPerPage) || 1;
    if (page > totalPages) currentPage = totalPages;
    if (page < 1) currentPage = 1;

    rows.forEach((row) => (row.style.display = "none"));
    const start = (currentPage - 1) * rowsPerPage;
    const end = start + rowsPerPage;
    filteredRows.slice(start, end).forEach((row) => (row.style.display = ""));
  }

  document.getElementById("prevPage")?.addEventListener("click", () => {
    currentPage--;
    showPage(currentPage);
  });
  document.getElementById("nextPage")?.addEventListener("click", () => {
    currentPage++;
    showPage(currentPage);
  });
  searchInput.addEventListener("keyup", () => {
    currentPage = 1;
    showPage(currentPage);
  });
  showPage(currentPage);

  function openEditBookModal(book) {
    document.getElementById("editBookModal").classList.remove("hidden");
    document.getElementById(
      "editBookForm"
    ).action = `/admin/books/edit/${book.id}`;
    document.getElementById("editTitle").value = book.title || "";
    document.getElementById("editAuthor").value = book.author || "";
    document.getElementById("editAccession").value = book.assecion_number || "";
    document.getElementById("editCall").value = book.call_number || "";
    document.getElementById("editPublisher").value = book.publisher || "";
    document.getElementById("editYear").value = book.year_published || "";
    document.getElementById("editSection").value = book.section_id || "";
    document.getElementById("editSubject").value = book.subject_type_id || "";
    document.getElementById("editEdition").value = book.edition_id || "";
  }

  function closeEditBookModal() {
    document.getElementById("editBookModal").classList.add("hidden");
  }
</script>
{% endblock %}
